<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polaroid Camera Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Gochi+Hand&display=swap" rel="stylesheet">
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils@0.6/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --bg-color: #dcdcdc;
            --camera-body: #fdf6e3; 
            --camera-dark: #e8dfc8;
            --lens-ring: #e8a89b;
            --ui-border: #333;
        }

        * { box-sizing: border-box; user-select: none; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; height: 100vh; height: 100dvh;
            background-color: var(--bg-color);
            background-image: radial-gradient(#bfbfbf 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            display: flex; align-items: center;
        }

        /* ==================== é¡¶éƒ¨ UI ==================== */
        .top-actions {
            position: absolute; top: 20px; right: 30px;
            display: flex; gap: 10px; z-index: 2000;
        }
        .ui-btn {
            background: #fff; padding: 8px 15px; border-radius: 30px;
            border: 2px solid var(--ui-border); font-weight: bold; cursor: pointer;
            font-family: 'Microsoft YaHei', sans-serif; font-size: 0.9rem;
            box-shadow: 3px 3px 0 var(--ui-border); transition: all 0.1s;
            white-space: nowrap;
        }
        .ui-btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 var(--ui-border); }
        #editBtn { background: #fffdf0; }

        /* ==================== å·¦ä¾§æ»¤é•œ & æ»‘åŠ¨æ¡ ==================== */
        .controls-wrapper {
            position: absolute; left: 30px; top: 50%; transform: translateY(-50%);
            display: flex; align-items: center; gap: 15px; z-index: 50;
            height: 400px; /* å®¹å™¨é™é«˜ */
            pointer-events: none; /* ç©¿é€ç‚¹å‡»ï¼Œå­å…ƒç´ å¼€å¯ */
        }

        .controls {
            pointer-events: auto;
            display: flex; flex-direction: column; gap: 15px;
            background: white; padding: 10px; border-radius: 15px;
            border: 2px solid var(--ui-border);
            box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
            
            max-height: 340px;
            overflow-y: auto; 
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE */

            /* === æ ¸å¿ƒå‡çº§ï¼šä¸Šä¸‹é€æ˜æ¸å˜é®ç½© === */
            /* è¿™ä¼šè®©åˆ—è¡¨é¡¶éƒ¨å’Œåº•éƒ¨å‡ºç°æ·¡å‡ºæ•ˆæœï¼Œæç¤ºç”¨æˆ·å¯ä»¥æ»šåŠ¨ */
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 95%, transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 95%, transparent 100%);
            /* å¢åŠ ä¸€ç‚¹å†…è¾¹è·é˜²æ­¢å†…å®¹è¢«é®å¤ªç‹  */
            padding-top: 15px; padding-bottom: 15px; 
        }
        .controls::-webkit-scrollbar { display: none; }

        .filter-btn {
            width: 50px; height: 50px; min-height: 50px;
            border-radius: 12px; border: 2px solid #eee;
            background: #fff; font-size: 28px; cursor: pointer;
            transition: all 0.2s; display: flex; justify-content: center; align-items: center;
            flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
        }
        .filter-btn.active { border-color: #e8a89b; background: #fff0ee; transform: scale(1.05); }
        .filter-btn:hover { background: #fafafa; }

        /* å°ºå¯¸è°ƒèŠ‚é¢æ¿ */
        .slider-panel {
            pointer-events: auto;
            background: white; padding: 15px 10px; border-radius: 15px;
            border: 2px solid var(--ui-border);
            box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            height: 160px; animation: fadeIn 0.2s ease-out;
        }
        .slider-label {
            writing-mode: vertical-lr; font-family: 'Microsoft YaHei', sans-serif; 
            font-size: 12px; color: #666; font-weight: bold; margin-bottom: 10px; letter-spacing: 2px;
        }
        
        .range-wrapper { position: relative; width: 20px; height: 100px; display: flex; justify-content: center; align-items: center; }
        input[type=range] {
            -webkit-appearance: none; width: 100px; height: 6px;
            background: #eee; border-radius: 5px; border: 1px solid #ccc;
            transform: rotate(-90deg); outline: none; cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%;
            background: #d68c7e; border: 2px solid #fff;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3); cursor: pointer;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        /* ==================== å¼¹çª— ==================== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
            z-index: 5000; display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-box {
            background: #fff; width: 85%; max-width: 400px; padding: 25px;
            border-radius: 20px; border: 3px solid var(--ui-border);
            box-shadow: 10px 10px 0 rgba(0,0,0,0.2);
            font-family: 'Microsoft YaHei', sans-serif; text-align: center;
        }
        .hand-input {
            width: 100%; border: none; border-bottom: 2px dashed #333;
            font-family: 'Gochi Hand', cursive; font-size: 1.5rem;
            padding: 10px; text-align: center; color: #d68c7e;
            background: transparent; margin-bottom: 20px;
        }
        .modal-actions { display: flex; justify-content: space-around; }
        .modal-btn {
            padding: 8px 25px; font-size: 1rem; border-radius: 10px;
            border: 2px solid #333; background: #fff; box-shadow: 3px 3px 0 #ccc;
        }
        .btn-confirm { background: #d68c7e; color: white; box-shadow: 3px 3px 0 #333; }

        /* ==================== ç›¸æœºä¸»ä½“ ==================== */
        .camera-wrapper {
            position: relative; margin-left: 150px;
            width: 360px; height: 450px; flex-shrink: 0;
            transition: transform 0.3s;
        }
        .texture-plastic {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        }
        .camera-body-base {
            position: absolute; bottom: 0; width: 360px; height: 360px;
            background-color: var(--camera-body); border-radius: 60px;
            box-shadow: 20px 20px 50px rgba(0,0,0,0.2), inset -5px -5px 15px rgba(0,0,0,0.1), inset 2px 2px 5px rgba(255,255,255,0.8);
            z-index: 10;
        }
        .printer-slot {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            width: 240px; height: 20px; background: #1a1a1a; border-radius: 4px; z-index: 15;
        }
        .camera-front-panel {
            position: absolute; bottom: 0; width: 360px; height: 360px;
            background: linear-gradient(135deg, var(--camera-body) 0%, var(--camera-dark) 100%);
            border-radius: 60px; border: 1px solid rgba(255,255,255,0.4);
            box-shadow: inset 4px 4px 10px rgba(255,255,255,0.9), inset -4px -4px 10px rgba(0,0,0,0.1), 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 20; display: flex; justify-content: center; align-items: center;
        }
        .lens-wrapper {
            position: relative; width: 240px; height: 240px;
            background: repeating-linear-gradient(45deg, #ddd, #ddd 2px, #eee 2px, #eee 4px);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            margin-top: 40px; box-shadow: 8px 8px 20px rgba(0,0,0,0.2), inset 2px 2px 5px rgba(255,255,255,1);
        }
        .lens-ring-pink {
            width: 200px; height: 200px; 
            background: radial-gradient(circle at 30% 30%, #f0dcd8 0%, var(--lens-ring) 80%);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            border: 2px solid rgba(255,255,255,0.5); box-shadow: inset 5px 5px 15px rgba(0,0,0,0.1), 0 5px 15px rgba(0,0,0,0.15);
        }
        .lens-glass {
            width: 140px; height: 140px; background: #111;
            border-radius: 50%; overflow: hidden; position: relative;
            border: 6px solid #222; box-shadow: inset 0 0 20px #000, inset 5px 5px 10px rgba(255,255,255,0.1);
        }
        .lens-glass::after {
            content: ''; position: absolute; top: 20px; right: 30px;
            width: 30px; height: 20px; background: rgba(255,255,255,0.1);
            border-radius: 50%; transform: rotate(45deg); pointer-events: none;
        }
        #arCanvas { width: 100%; height: 100%; object-fit: cover; }
        #sourceVideo { position: absolute; top: 0; left: 0; opacity: 0; pointer-events: none; width: 1px; height: 1px; }

        .camera-features { position: absolute; top: 40px; left: 40px; right: 40px; display: flex; justify-content: space-between; }
        .flash {
            width: 80px; height: 50px; background: #2a2a2a;
            border-radius: 10px; border: 3px solid #ccc; position: relative; overflow: hidden;
            background-image: repeating-linear-gradient(90deg, transparent, transparent 4px, rgba(255,255,255,0.1) 4px, rgba(255,255,255,0.1) 5px);
        }
        .viewfinder {
            width: 50px; height: 50px; background: #111; border-radius: 50%; border: 4px solid #333;
        }
        @keyframes pulse-btn {
            0% { box-shadow: inset 2px 2px 5px rgba(255,255,255,0.4), 0 0 0 0 rgba(214, 140, 126, 0.7); }
            70% { box-shadow: inset 2px 2px 5px rgba(255,255,255,0.4), 0 0 0 10px rgba(214, 140, 126, 0); }
            100% { box-shadow: inset 2px 2px 5px rgba(255,255,255,0.4), 0 0 0 0 rgba(214, 140, 126, 0); }
        }
        .shutter-btn {
            position: absolute; top: 180px; left: 20px; width: 60px; height: 60px; 
            background: radial-gradient(circle at 40% 40%, #e89b8e 0%, #d68c7e 100%);
            border-radius: 50%; border: none; cursor: pointer; z-index: 30;
            animation: pulse-btn 2s infinite;
        }
        .shutter-btn:active { transform: scale(0.95); animation: none; }
        .lens-flash-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; opacity: 0; border-radius: 50%; pointer-events: none;
            transition: opacity 0.1s ease-out; z-index: 100;
        }

        /* ==================== ç…§ç‰‡ ==================== */
        .desk-area { flex-grow: 1; height: 100%; position: relative; z-index: 5; overflow: hidden; }

        .polaroid {
            position: absolute; width: 220px; padding: 15px 15px 40px 15px;
            background: #fff; box-shadow: 5px 5px 20px rgba(0,0,0,0.15);
            transform-origin: center; cursor: grab; touch-action: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
        }
        .polaroid-save-btn {
            position: absolute; top: -12px; right: -12px;
            width: 30px; height: 30px; background: #333; color: #fff;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 16px; cursor: pointer; border: 2px solid #fff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); z-index: 10;
        }
        .polaroid img {
            width: 100%; height: 220px; object-fit: cover;
            background: #eee; filter: contrast(1.1) sepia(0.2); pointer-events: none; border: 1px solid #eee;
        }
        .polaroid-text {
            margin-top: 15px; font-family: 'Gochi Hand', cursive;
            color: #333; text-align: center; font-size: 1.2rem; pointer-events: none;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .date-stamp { font-size: 0.8rem; color: #888; text-align: right; margin-top: 5px; font-family: monospace; }
        .polaroid.printing {
            left: 50% !important; top: 100px !important; 
            transform: translateX(-50%) scale(0.9); z-index: 12 !important; box-shadow: none;
            transition: top 3s linear, transform 3s ease-out;
        }
        .polaroid.printed { top: -150px !important; transform: translateX(-50%) scale(1); }
        .hide-in-shot { display: none !important; }
        #loadingMask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            font-family: 'Segoe UI', sans-serif; text-align: center;
        }

        /* ==================== ğŸ“± ç§»åŠ¨ç«¯é€‚é… ==================== */
        @media (max-width: 768px) {
            body { flex-direction: column; justify-content: flex-start; padding-top: 60px; }
            .camera-wrapper { margin-left: 0; transform: scale(0.8); transform-origin: top center; margin-bottom: -60px; }
            .desk-area { width: 100%; min-height: 400px; border-top: 1px dashed #ccc; }
            .top-actions { top: 10px; right: 10px; width: auto; }
            .ui-btn { font-size: 0.8rem; padding: 6px 12px; }
            
            .controls-wrapper { left: 10px; top: 80px; transform: none; height: 300px; }
            .controls { padding: 10px 5px; gap: 8px; max-height: 250px; }
            .filter-btn { width: 40px; height: 40px; font-size: 20px; min-height: 40px; }
            
            .slider-panel { height: 130px; }
            .range-wrapper { height: 80px; }
            input[type=range] { width: 80px; }

            .polaroid.printing { top: 50px !important; }
            .polaroid.printed { top: -100px !important; }
        }
    </style>
</head>
<body>

    <div id="loadingMask">
        <h2>æ­£åœ¨å¯åŠ¨ç›¸æœº AI...</h2>
        <p>è¯·å…è®¸æ‘„åƒå¤´æƒé™</p>
        <div id="logOutput">åˆå§‹åŒ–ä¸­...</div>
    </div>

    <div class="top-actions">
        <button class="ui-btn" id="editBtn">âœ æ–‡æ¡ˆ</button>
        <button class="ui-btn" id="downloadDeskBtn">ğŸ’¾ ä¿å­˜</button>
    </div>

    <div class="modal-overlay" id="textModal">
        <div class="modal-box">
            <div class="modal-title">è¾“å…¥ä½ çš„æ–‡æ¡ˆ</div>
            <input type="text" id="captionInput" class="hand-input" maxlength="20" value="May I Meet You">
            <div class="modal-actions">
                <button class="modal-btn" id="cancelTextBtn">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" id="saveTextBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="controls-wrapper">
        <div class="controls">
            <div class="filter-btn active" onclick="setFilter(null)">ğŸš«</div>
            
            <div class="filter-btn" onclick="setFilter('ğŸ¶')">ğŸ¶</div>
            <div class="filter-btn" onclick="setFilter('ğŸ±')">ğŸ±</div>
            <div class="filter-btn" onclick="setFilter('ğŸ°')">ğŸ°</div>
            <div class="filter-btn" onclick="setFilter('ğŸ»')">ğŸ»</div>
            <div class="filter-btn" onclick="setFilter('ğŸ¼')">ğŸ¼</div>
            <div class="filter-btn" onclick="setFilter('ğŸ¦Š')">ğŸ¦Š</div>
            <div class="filter-btn" onclick="setFilter('ğŸ¦')">ğŸ¦</div>
            <div class="filter-btn" onclick="setFilter('ğŸ¯')">ğŸ¯</div>
            <div class="filter-btn" onclick="setFilter('ğŸ¨')">ğŸ¨</div>
            <div class="filter-btn" onclick="setFilter('ğŸ·')">ğŸ·</div>
            
            <div class="filter-btn" onclick="setFilter('ğŸ˜')">ğŸ˜</div>
            <div class="filter-btn" onclick="setFilter('ğŸ˜')">ğŸ˜</div>
            <div class="filter-btn" onclick="setFilter('ğŸ¤ ')">ğŸ¤ </div>
            <div class="filter-btn" onclick="setFilter('ğŸ‘»')">ğŸ‘»</div>
            <div class="filter-btn" onclick="setFilter('ğŸ‘½')">ğŸ‘½</div>
            <div class="filter-btn" onclick="setFilter('ğŸ¤–')">ğŸ¤–</div>
        </div>
        
        <div class="slider-panel" id="sizeSliderPanel">
            <div class="slider-label">å°ºå¯¸</div>
            <div class="range-wrapper">
                <input type="range" id="sizeSlider" min="0.5" max="3.0" step="0.1" value="1.5">
            </div>
        </div>
    </div>

    <div class="camera-wrapper" id="cameraWrapper">
        <div class="camera-body-base texture-plastic"></div>
        <div class="printer-slot"></div>
        
        <div class="camera-front-panel texture-plastic">
            <div class="camera-features">
                <div class="flash"></div>
                <div class="viewfinder"></div>
            </div>
            <div class="lens-wrapper">
                <div class="lens-ring-pink">
                    <div class="lens-glass">
                        <div class="lens-flash-overlay" id="localFlash"></div>
                        <canvas id="arCanvas" width="400" height="400"></canvas>
                        <video id="sourceVideo" playsinline></video>
                    </div>
                </div>
            </div>
            <button class="shutter-btn" id="shutterBtn"></button>
        </div>
    </div>

    <div class="desk-area" id="deskArea"></div>

    <script>
        const logDiv = document.getElementById('logOutput');
        function log(msg) { console.log(msg); if(logDiv) logDiv.innerText = msg; }

        let activeEmoji = null;
        let currentCaption = "May I Meet You";
        let zIndexCounter = 100;
        let emojiScale = 1.5;

        const video = document.getElementById('sourceVideo');
        const canvas = document.getElementById('arCanvas');
        const ctx = canvas.getContext('2d');
        const loadingMask = document.getElementById('loadingMask');
        const cameraWrapper = document.getElementById('cameraWrapper');
        const deskArea = document.getElementById('deskArea');
        const sizeSlider = document.getElementById('sizeSlider');
        const sliderPanel = document.getElementById('sizeSliderPanel');

        // ç›‘å¬å…¨å±€ç‚¹å‡»ï¼Œå®ç°ç‚¹å‡»ç©ºç™½éšè—æ»‘å—
        document.addEventListener('click', (e) => {
            const wrapper = document.querySelector('.controls-wrapper');
            // å¦‚æœç‚¹å‡»çš„ç›®æ ‡ä¸åœ¨å·¦ä¾§æ§åˆ¶åŒºåŸŸå†…ï¼Œåˆ™éšè—æ»‘å—
            if (!wrapper.contains(e.target)) {
                sliderPanel.style.display = 'none';
            }
        });

        sizeSlider.addEventListener('input', (e) => {
            emojiScale = parseFloat(e.target.value);
        });

        async function init() {
            try {
                log("åŠ è½½ç»„ä»¶...");
                const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/${file}`});
                faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                faceMesh.onResults(onResults);

                log("è¯·æ±‚æ‘„åƒå¤´...");
                const camera = new Camera(video, {
                    onFrame: async () => { await faceMesh.send({image: video}); },
                    width: 400, height: 400
                });

                await camera.start();
                log("å¯åŠ¨æˆåŠŸï¼");
                loadingMask.style.display = 'none';
            } catch (err) {
                console.error(err);
                log("é”™è¯¯: " + err.message);
                alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿åœ¨ HTTPS ç¯å¢ƒæˆ–ä½¿ç”¨ Live Serverã€‚");
            }
        }
        init();

        function onResults(results) {
            ctx.save();
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0 && activeEmoji) {
                const landmarks = results.multiFaceLandmarks[0];
                const nose = landmarks[1];
                const left = landmarks[234];
                const right = landmarks[454];
                
                const x = nose.x * canvas.width;
                const y = nose.y * canvas.height;
                const faceWidth = Math.abs(right.x - left.x) * canvas.width;
                
                const size = faceWidth * emojiScale; 

                let angle = Math.atan2(right.y - left.y, right.x - left.x);
                // === æ ¸å¿ƒä¿®å¤ï¼šç§»é™¤ angle = -angleï¼Œè®©æ—‹è½¬æ–¹å‘æ­£ç¡®è·Ÿéšå¤´éƒ¨ ===
                // angle = -angle; // æ­¤è¡Œä»£ç å·²åˆ é™¤ï¼Œè§£å†³åå‘é—®é¢˜

                ctx.translate(x, y);
                ctx.rotate(angle);
                ctx.font = `${size}px "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.scale(-1, 1); 
                ctx.fillText(activeEmoji, 0, 0);
            }
            ctx.restore();
        }

        window.setFilter = (emoji) => {
            activeEmoji = emoji;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.innerText === (emoji || 'ğŸš«')) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            if (emoji) {
                sliderPanel.style.display = 'flex';
            } else {
                sliderPanel.style.display = 'none';
            }
        }

        // Modal Logic
        const modal = document.getElementById('textModal');
        const captionInput = document.getElementById('captionInput');
        document.getElementById('editBtn').addEventListener('click', () => { captionInput.value = currentCaption; modal.classList.add('show'); });
        document.getElementById('saveTextBtn').addEventListener('click', () => { if(captionInput.value.trim()) currentCaption = captionInput.value.trim(); modal.classList.remove('show'); });
        document.getElementById('cancelTextBtn').addEventListener('click', () => { modal.classList.remove('show'); });

        // Photo Logic
        document.getElementById('shutterBtn').addEventListener('click', () => {
            const flash = document.getElementById('localFlash');
            flash.style.opacity = 1;
            setTimeout(() => flash.style.opacity = 0, 100);
            const imgUrl = canvas.toDataURL('image/jpeg', 0.95);
            createPolaroid(imgUrl);
        });

        function createPolaroid(imgUrl) {
            const div = document.createElement('div');
            div.className = 'polaroid printing';
            
            const now = new Date();
            const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`;

            const saveBtn = document.createElement('div');
            saveBtn.className = 'polaroid-save-btn';
            saveBtn.innerHTML = 'â¬‡';
            saveBtn.addEventListener('touchstart', (e) => { e.stopPropagation(); downloadSinglePolaroid(div); });
            saveBtn.addEventListener('mousedown', (e) => { e.stopPropagation(); downloadSinglePolaroid(div); });

            div.innerHTML = `
                <img src="${imgUrl}" draggable="false">
                <div class="polaroid-text">${currentCaption}</div>
                <div class="date-stamp">${dateStr}</div>
            `;
            div.appendChild(saveBtn);

            cameraWrapper.appendChild(div);
            setTimeout(() => { div.classList.add('printed'); }, 100);
            setTimeout(() => {
                const rect = div.getBoundingClientRect();
                div.classList.remove('printing', 'printed');
                div.style.position = 'absolute';
                div.style.left = (rect.left + window.scrollX) + 'px';
                div.style.top = (rect.top + window.scrollY) + 'px';
                div.style.transform = `rotate(${Math.random() * 10 - 5}deg)`;
                div.style.zIndex = zIndexCounter++;
                deskArea.appendChild(div);
                makeDraggable(div);
            }, 3100);
        }

        function downloadSinglePolaroid(element) {
            const btn = element.querySelector('.polaroid-save-btn');
            btn.classList.add('hide-in-shot'); 
            const originalTransform = element.style.transform;
            element.style.transform = 'scale(1) rotate(0deg)';
            
            html2canvas(element, { backgroundColor: null, scale: 2, useCORS: true }).then(canvas => {
                element.style.transform = originalTransform;
                const link = document.createElement('a');
                link.download = `polaroid_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                btn.classList.remove('hide-in-shot');
            });
        }

        document.getElementById('downloadDeskBtn').addEventListener('click', () => {
            const els = ['.top-actions', '.controls-wrapper', '.polaroid-save-btn'];
            els.forEach(sel => document.querySelectorAll(sel).forEach(el => el.classList.add('hide-in-shot')));
            
            html2canvas(document.body, { backgroundColor: null, scale: window.devicePixelRatio }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'my-polaroid-desk.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                els.forEach(sel => document.querySelectorAll(sel).forEach(el => el.classList.remove('hide-in-shot')));
            });
        });

        // Touch Drag
        function makeDraggable(element) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            const startDrag = (clientX, clientY) => {
                isDragging = true;
                element.style.zIndex = zIndexCounter++;
                startX = clientX;
                startY = clientY;
                initialLeft = element.offsetLeft;
                initialTop = element.offsetTop;
                element.style.cursor = 'grabbing';
            };

            const moveDrag = (clientX, clientY) => {
                if (!isDragging) return;
                const dx = clientX - startX;
                const dy = clientY - startY;
                element.style.left = `${initialLeft + dx}px`;
                element.style.top = `${initialTop + dy}px`;
            };

            const endDrag = () => {
                isDragging = false;
                element.style.cursor = 'grab';
            };

            element.addEventListener('mousedown', (e) => {
                if(e.target.classList.contains('polaroid-save-btn')) return;
                startDrag(e.clientX, e.clientY);
            });
            window.addEventListener('mousemove', (e) => {
                e.preventDefault(); 
                moveDrag(e.clientX, e.clientY);
            });
            window.addEventListener('mouseup', endDrag);

            element.addEventListener('touchstart', (e) => {
                if(e.target.classList.contains('polaroid-save-btn')) return;
                e.preventDefault(); 
                const touch = e.touches[0];
                startDrag(touch.clientX, touch.clientY);
            }, { passive: false });

            window.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                e.preventDefault(); 
                const touch = e.touches[0];
                moveDrag(touch.clientX, touch.clientY);
            }, { passive: false });

            window.addEventListener('touchend', endDrag);
        }
    </script>
</body>
</html>